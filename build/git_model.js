/*csd*/define(function(require,exports,module){var d=exports;var c=require("self/models/process");var a=require("self/models/console");var b=require("self/models/file_manager");var e=require("mokit/utils");d.repos=[];d.repoPath="";d.branchs=[];d.branchName="";d.changedFiles=[];d.commits=[];d.remotes=[];d.remote="";d.exec=function(g,f){a.info(g+"\r\n");var g=c.exec(g,{cwd:d.repoPath},function(){if(f){f(g.buffer.out);}});};d.loadRepos=function(f){d.repos=[];e.each(b.currentInfo,function(g,h){if(h.type=="dir"&&h.isRoot){d.repos.push(h);}});if(d.repos.length>0){d.switchRepo(d.repoPath||d.repos[0].path,f);}};d.loadBranchs=function(f){d.branchs=[];d.exec("git branch",function(h){if(!e.isNull(h)){var g=h.split("\n");e.each(g,function(k,l){var j=e.trim(l);if(e.startWith(j,"*")){j=e.trim(j.replace("*",""));d.branchName=j;}if(j!==""){d.branchs.push(j);}});d.switchBranch(d.branchName,f);}else{d.changedFiles=[];if(f){f(h);}}});};d.switchRepo=function(g,f){d.repoPath=g;d.branchs=[];d.remotes=[];d.changedFiles=[];d.commits=[];d.remote="";d.branchName="";d.loadBranchs(function(){d.loadRemote(function(){d.loadCommit(f);});});a.write('Repo Switch To "'+d.repoPath+'"\r\n');};d.switchBranch=function(f,g){d.branchName=f;d.changedFiles=[];d.exec("git add .",function(){d.exec("git checkout "+d.branchName,function(i){if(!e.isNull(i)){i=i.split("Your branch is ")[0];var h=i.split("\n");e.each(h,function(k,l){var j=e.trim(l);if(j!=""){d.changedFiles.push(l);}});}d.loadCommit(g);a.write('Branch Switch To "'+d.branchName+'"\r\n');});});};d.refreshBranch=function(f){d.switchBranch(d.branchName,f);};d.deleteBranch=function(f,g){};d.loadRemote=function(f){d.remotes=[];d.exec("git remote",function(g){if(!e.isNull(g)){var h=g.split("\n");e.each(h,function(j,k){var l=e.trim(k);if(l!=""){d.remotes.push(k);}});}d.setRemote(d.remote||d.remotes[0],f);});};d.setRemote=function(g,f){d.remote=g;if(f){f();}};d.initRepo=function(f){d.exec("git init",f);};d.clone=function(g,f){d.exec("git clone "+g,f);};d.pull=function(f){d.exec("git pull",f);};d.push=function(f){d.exec("git push "+d.remote+" "+d.branchName+":"+d.branchName,function(){d.loadCommit(f);});};d.commit=function(g,f){d.exec('git commit -a -m "'+g+'"',function(){d.refreshBranch(function(){d.loadCommit(f);});});};d.loadCommit=function(f,h){d.commits=[];var g="git log ";if(d.remote!=""&&d.branchName!=""&&!h){g+=d.branchName+" ^"+d.remote+"/"+d.branchName;}d.exec(g,function(i){if((e.isNull(i)||e.contains(i,"fatal"))&&!h){if(f){f();}return;}else{i=i.split("\n");e.each(i,function(k,l){if(e.startWith(l,"  ")){var j=e.trim(l);if(j!=""){d.commits.push(j);}}});if(f){f();}}});};});